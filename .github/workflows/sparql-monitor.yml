name: SPARQL Monitor Workflow

on:
  push:
    branches: [ main ]
    paths-ignore:
      - 'monitor_results/**'
  pull_request:
    branches: [ main ]
    paths-ignore:
      - 'monitor_results/**'
  schedule:
    - cron: '0 3 1-7 * 1'  # Alle 3 AM del primo luned√¨ del mese

jobs:
  monitor:
    runs-on: ubuntu-latest
    
    steps:
    - uses: actions/checkout@v3
    
    - name: Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.12'
        
    - name: Install dependencies
      run: |
        python -m pip install --upgrade pip
        pip install -r requirements.txt
        pip install beautifulsoup4
        
    - name: Run SPARQL monitor
      run: |
        cd monitor
        python -m main

    - name: Create website from HTML reports
      run: |
        python3 << 'EOF'
        import os
        from datetime import datetime
        from bs4 import BeautifulSoup

        # Trova gli ultimi report HTML
        meta_dir = 'monitor_results/meta_reports'
        index_dir = 'monitor_results/index_reports'
        latest_meta = sorted(os.listdir(meta_dir))[-1]
        latest_index = sorted(os.listdir(index_dir))[-1]

        # Estrai le tabelle dai report HTML
        def extract_table(filepath):
            with open(filepath, 'r') as f:
                soup = BeautifulSoup(f, 'html.parser')
                return str(soup.find('table'))  # Estrae solo il tag table

        meta_table = extract_table(f"{meta_dir}/{latest_meta}/meta_monitor_vis*.html")
        index_table = extract_table(f"{index_dir}/{latest_index}/index_monitor_vis*.html")

        # Template HTML personalizzato
        html = f"""<!DOCTYPE html>
        <html lang="en">
        <head>
            <meta charset="UTF-8">
            <meta name="viewport" content="width=device-width, initial-scale=1.0">
            <title>OpenCitations Data Quality Monitor</title>
            <style>
                body {{
                    font-family: Arial, sans-serif;
                    margin: 0;
                    padding: 20px;
                    background-color: #f5f5f5;
                }}
                .container {{
                    max-width: 1200px;
                    margin: 0 auto;
                    background-color: white;
                    padding: 20px;
                    border-radius: 8px;
                    box-shadow: 0 2px 4px rgba(0,0,0,0.1);
                }}
                h1 {{
                    color: #333;
                    text-align: center;
                }}
                .section {{
                    margin: 20px 0;
                    padding: 20px;
                    border: 1px solid #ddd;
                    border-radius: 4px;
                }}
                table {{
                    width: 100%;
                    border-collapse: collapse;
                    margin-top: 10px;
                }}
                th, td {{
                    padding: 12px;
                    text-align: left;
                    border-bottom: 1px solid #ddd;
                }}
                th {{
                    background-color: #f8f8f8;
                }}
                .passed {{
                    color: green;
                }}
                .failed {{
                    color: red;
                }}
                .error {{
                    color: orange;
                }}
                .null {{
                    color: #999;
                }}
                .timestamp {{
                    text-align: center;
                    color: #666;
                    margin-top: 20px;
                }}
            </style>
        </head>
        <body>
            <div class="container">
                <h1>OpenCitations Data Quality Monitor</h1>
                
                <div class="section">
                    <h2>Meta Monitor Results</h2>
                    {meta_table}
                </div>

                <div class="section">
                    <h2>Index Monitor Results</h2>
                    {index_table}
                </div>

                <div class="timestamp">
                    Last updated: {datetime.now().strftime('%d/%m/%Y, %H:%M:%S')}
                </div>
            </div>
        </body>
        </html>
        """
        
        with open('index.html', 'w') as f:
            f.write(html)
        EOF

    - name: Commit monitoring results to main
      run: |
        git config --local user.email "github-actions[bot]@users.noreply.github.com"
        git config --local user.name "github-actions[bot]"
        git add monitor_results/
        git commit -m "Add new monitoring results [automated]" || echo "No changes to commit"
        git push

    - name: Push index.html to gitwebsite branch
      run: |
        # Crea e resetta il branch gitwebsite per contenere solo index.html
        git checkout --orphan gitwebsite-temp  # Crea un nuovo branch vuoto
        git rm -rf .  # Rimuove tutti i file tracciati
        git clean -fd  # Rimuove tutti i file non tracciati
        mv index.html .  # Sposta index.html nella root
        git add index.html
        git config --local user.email "github-actions[bot]@users.noreply.github.com"
        git config --local user.name "github-actions[bot]"
        git commit -m "Update website [automated]"
        git branch -D gitwebsite || true  # Elimina il vecchio branch se esiste
        git branch -m gitwebsite  # Rinomina il branch corrente in gitwebsite
        git push -f origin gitwebsite  # Force push del nuovo stato

    - name: Upload monitoring results as artifacts
      uses: actions/upload-artifact@v3
      with:
        name: monitor-results
        path: monitor_results/